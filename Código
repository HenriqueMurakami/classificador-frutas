# ========== INSTALAÃ‡ÃƒO E IMPORTAÃ‡Ã•ES ==========
!pip install --upgrade pillow scikit-image --quiet
!pip install fastai ipywidgets --quiet #biblioteca de deep learning que simplifica o treinamento de modelos

from fastai.vision.all import *
from pathlib import Path
from google.colab import drive
from ipywidgets import widgets
from IPython.display import display, clear_output
import PIL #Biblioteca para manipulaÃ§Ã£o de imagens em Python
from PIL import Image, ImageFile
import warnings

# ConfiguraÃ§Ãµes para evitar erros
ImageFile.LOAD_TRUNCATED_IMAGES = True
warnings.filterwarnings('ignore', category=UserWarning)

# ========== CONEXÃƒO COM GOOGLE DRIVE ==========
drive.mount('/content/drive')

# ========== CONFIGURAÃ‡ÃƒO DO DATASET ==========
path = Path('/content/drive/MyDrive/frutas_dataset')
# Formatos suportados (apenas JPG e PNG)
FORMATOS_SUPORTADOS = ['.jpg', '.jpeg', '.png']

# FunÃ§Ã£o otimizada para verificar imagens
# FunÃ§Ã£o responsÃ¡vel por validar se um arquivo Ã© uma imagem, verificando sua extensÃ£o e tentando realizar a abertura do arquivo
def verificar_imagem(img_path):
    try:
        if img_path.suffix.lower() not in FORMATOS_SUPORTADOS:
            return False
        with Image.open(img_path) as img:
            img.verify()
            return True
    except Exception as e:
        return False

# Processamento do dataset com relatÃ³rio detalhado
#Verifica a qualidade do dataset, se esta tudo certo para rodar
print("ğŸ” Analisando e carregando dataset de frutas...")
print(f"ğŸ“Œ Formatos suportados: {', '.join(FORMATOS_SUPORTADOS)}")

for folder in path.ls():
    if folder.is_dir():
        validas, invalidas = [], []
        for ext in FORMATOS_SUPORTADOS:
            for img_path in folder.glob(f'*{ext}'):
                if verificar_imagem(img_path):
                    validas.append(img_path)
                else:
                    invalidas.append(img_path.name)
        
        print(f"\nğŸ“ {folder.name}:")
        print(f"âœ… {len(validas)} amostras de imagens extraÃ­das do dataset")
        if invalidas:
            print(f"âŒ {len(invalidas)} arquivos problemÃ¡ticos")
            print(f"   Exemplos: {', '.join(invalidas[:3])}" + 
                 ("..." if len(invalidas) > 3 else ""))
        
        if validas:
            img = PILImage.create(validas[0]).resize((200, 200))
            display(img)

# ========== CRIAÃ‡ÃƒO DO MODELO ==========
#Aqui, de fato, os dados sÃ£o preparados para o treinamento.
#learn - modelo Ã© criado e treinado.
#resnet18: arquitetura da rede neural prÃ©-treinada.
#fine_tune(10): realiza o treinamento do modelo em ciclos
#error_rate: calcula a taxa de erro do modelo.

try:
    dls = ImageDataLoaders.from_folder(
        path,
        train=".",
        valid_pct=0.2,
        item_tfms=Resize(460),
        batch_tfms=aug_transforms(size=224),
        bs=8,
        extensions=FORMATOS_SUPORTADOS
    )
    
    learn = vision_learner(dls, resnet18, metrics=error_rate)
    print("\nğŸ¯ Iniciando processo de treinamento do modelo de aprendizado, fundamentado nos rÃ³tulos e imagens presentes no dataset....")
    learn.fine_tune(10)
    
except Exception as e:
    print(f"\nâŒ Erro ao criar modelo: {str(e)}")
    raise

# ========== DICIONÃRIO DE INFORMAÃ‡Ã•ES NUTRICIONAIS ==========
# Informa a tabela nutricional de acordo com a fruta classificada
info_frutas = {
    "maca": "ğŸ A maÃ§Ã£ Ã© rica em vitaminas do complexo B (B1, B2, B6), vitamina C e antioxidantes.",
    "banana": "ğŸŒ A banana Ã© uma excelente fonte de potÃ¡ssio, vitamina B6 e vitamina C.",
    "uva": "ğŸ‡ A uva contÃ©m vitamina C, vitamina K e antioxidantes como o resveratrol.",
    "limao": "ğŸ‹ O limÃ£o Ã© extremamente rico em vitamina C e tambÃ©m contÃ©m vitaminas do complexo B."
}

# ========== INTERFACE DE TESTE ==========
out = widgets.Output()

def processar_upload(change):
    with out:
        clear_output()
        if change['new']:
            try:
                # Carrega e exibe a imagem    
                img = PILImage.create(change['owner'].data[0])
                display(img.resize((300, 300)))
                # PrediÃ§Ã£o
                pred, _, prob = learn.predict(img)
                confianca = prob.max().item() * 100
                # Exibe resultados
                print("ğŸ”¬ Resultado da AnÃ¡lise:")
                print(f"ğŸ“ Fruta: {pred}")
                print(f"ğŸ“ˆ ConfianÃ§a: {confianca:.1f}%")

                # Dicas visuais
                if confianca > 90:
                    print("âœ… ConfianÃ§a excelente: A identificaÃ§Ã£o foi feita com alta precisÃ£o. Pode confiar no resultado!")
                elif confianca > 70:
                    print("ğŸ” Resultado provÃ¡vel. Considere verificar com outra imagem para maior precisÃ£o.")
                else:
                    print("âš ï¸ ConfianÃ§a baixa: Tente uma imagem mais nÃ­tida ou com melhor iluminaÃ§Ã£o.")

                # InformaÃ§Ã£o nutricional baseada na fruta
                fruta_detectada = str(pred).lower()
                if fruta_detectada in info_frutas:
                    print("\nğŸ§ª InformaÃ§Ã£o nutricional:")
                    print(info_frutas[fruta_detectada])
                else:
                    print("\nâ„¹ï¸ InformaÃ§Ã£o nutricional nÃ£o encontrada para esta fruta.")

            except PIL.UnidentifiedImageError:
                print("ğŸš« Formato nÃ£o suportado. Use JPG ou PNG.")
            except Exception as e:
                print(f"âš ï¸ Erro: {str(e)}")

# ConfiguraÃ§Ã£o do widget de upload
uploader = widgets.FileUpload(
    description='Selecionar',
    multiple=False
)
uploader.observe(processar_upload, names='data')

# ExibiÃ§Ã£o da interface
display(widgets.VBox([
    widgets.HTML("<h3 style='color:white'>ğŸ‰ Classificador de Frutas ğŸŒ</h3>"),
    widgets.Label("Envie uma foto de fruta para anÃ¡lise:"),
    uploader,
    out
]))

print("\nâœ… ClassificaÃ§Ã£o concluÃ­da com sucesso!")
